# í•­í•´ í”ŒëŸ¬ìŠ¤ ì´ì»¤ë¨¸ìŠ¤ í”„ë¡œì íŠ¸ ì¡°íšŒ ì„±ëŠ¥ ìµœì í™” ì „ëµ

## ê°œìš”

ì´ì»¤ë¨¸ìŠ¤ í”Œë«í¼ì€ ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ì‚¬ìš©ìì—ê²Œ ë¹ ë¥¸ ì‘ë‹µì„ ì œê³µí•´ì•¼ í•˜ë¯€ë¡œ ì„±ëŠ¥ ìµœì í™”ëŠ” ì‹œìŠ¤í…œì˜ í•µì‹¬ ìš”ì†Œì…ë‹ˆë‹¤.   
ë³¸ ë¬¸ì„œëŠ” í•­í•´ í”ŒëŸ¬ìŠ¤ ì´ì»¤ë¨¸ìŠ¤ í”„ë¡œì íŠ¸ì˜ ì¡°íšŒ ì„±ëŠ¥ì„ ìµœì í™”í•˜ê¸° ìœ„í•œ ì „ëµê³¼ ì‹¤ì œ êµ¬í˜„ ë°©ì•ˆì„ ë‹¤ë£¹ë‹ˆë‹¤.  
í˜„ì¬ ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì€ ì£¼ë¬¸, ìƒí’ˆ, í¬ì¸íŠ¸, ì¿ í° ë„ë©”ì¸ì„ ë‹¤ë£¨ê³  ìˆìœ¼ë©° ëŒ€í‘œì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì€ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.

- ìƒí’ˆ ì¡°íšŒ API
- ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ API
- í¬ì¸íŠ¸ ì¶©ì „ API
- í¬ì¸íŠ¸ ê²°ì œ API
- ì£¼ë¬¸ API
- ì¸ê¸° ìƒí’ˆ ì¡°íšŒ API

ë³¸ ë¬¸ì„œì—ì„œëŠ” ì´ ê¸°ëŠ¥ë“¤ì„ ìˆ˜í–‰í•˜ë©´ì„œì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ëŒ€í‘œì ì¸ ëª‡ ê°€ì§€ ìƒí™©ë“¤ì˜ ì¡°íšŒ ì„±ëŠ¥ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³ ,  
ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ì‹± ì „ëµì„ í†µí•œ ìµœì í™” ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.

## âœ… published_coupon í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì ì¿ í° ë°œê¸‰ ì—¬ë¶€ ì¡°íšŒ ì„±ëŠ¥ ë¶„ì„

### 1. ì‹œë‚˜ë¦¬ì˜¤ ë° ë¬¸ì œ ì •ì˜

published_coupon í…Œì´ë¸”ì€ ìœ ì €ì—ê²Œ ë°œê¸‰ëœ ì¿ í° ì •ë³´ë¥¼ ì €ì¥í•˜ë©°, ì•½ 1,000ë§Œ ê±´ì˜ ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.  
ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ APIì—ì„œëŠ” íŠ¹ì • ì‚¬ìš©ìê°€ íŠ¹ì • ì¿ í°ì„ ì´ë¯¸ ë°œê¸‰ë°›ì•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¿¼ë¦¬ê°€ í•„ìˆ˜ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

```sql
SELECT 1
FROM published_coupon
WHERE user_id = 1
  AND coupon_id = 1 LIMIT 1;
```

### 2. ì‹¤í–‰ ê³„íš ë¶„ì„

**2-1 CASE 1: ê²°ê³¼ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°**

```sql
-> Limit: 1 row(s)  (cost=996832 rows=1) (actual time=0.549..0.549 rows=1 loops=1)
    -> Filter: ((published_coupon.coupon_id = 432) and (published_coupon.user_id = 8478465))  (cost=996832 rows=94498) (actual time=0.548..0.548 rows=1 loops=1)
        -> Table scan on published_coupon  (cost=996832 rows=9.45e+6) (actual time=0.536..0.541 rows=77 loops=1)
```

- ì „ì²´ í…Œì´ë¸” ìŠ¤ìº”(Full Table Scan)ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.
- ìš´ì´ ì¢‹ê²Œë„ ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ LIMIT 1 ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ìŠ¤ìº”ì´ ì¡°ê¸° ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
- ì‹¤í–‰ ì‹œê°„: ì•½ 0.549ms

2-2. CASE 2: ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°

```sql
-> Limit: 1 row(s)  (cost=996832 rows=1) (actual time=1882..1882 rows=0 loops=1)
    -> Filter: ((published_coupon.coupon_id = 1) and (published_coupon.user_id = 8478465))  (cost=996832 rows=94498) (actual time=1882..1882 rows=0 loops=1)
        -> Table scan on published_coupon  (cost=996832 rows=9.45e+6) (actual time=0.391..1622 rows=10e+6 loops=1)
```

- ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ í…Œì´ë¸” ì „ì²´(1000ë§Œ ê±´)ë¥¼ ìŠ¤ìº”í–ˆìŠµë‹ˆë‹¤.
- LIMIT 1 ì¡°ê±´ì´ ë¬´ì˜ë¯¸í•´ì¡Œìœ¼ë©°, ëª¨ë“  ë ˆì½”ë“œë¥¼ ê²€ì‚¬í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.
- ì‹¤í–‰ ì‹œê°„: ì•½ 1.882ì´ˆ (ê²°ê³¼ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ë³´ë‹¤ ì•½ 3,600ë°° ëŠë¦¼)

ì´ëŸ¬í•œ ì„±ëŠ¥ ì°¨ì´ëŠ” ì‚¬ìš©ì ê²½í—˜ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ë¯¸ì¹˜ë©°, íŠ¹íˆ ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ê³¼ ê°™ì€ ì‹¤ì‹œê°„ íŠ¸ëœì­ì…˜ì—ì„œ ì‹¬ê°í•œ ë³‘ëª© í˜„ìƒì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3. ì„±ëŠ¥ ê°œì„  ì „ëµ: ë³µí•© ì¸ë±ìŠ¤ êµ¬í˜„

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ë³µí•© ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€í•  ê²ƒì…ë‹ˆë‹¤.

```sql
CREATE INDEX idx_user_coupon ON published_coupon (user_id, coupon_id);
```

ì´ ë³µí•© ì¸ë±ìŠ¤ì˜ ì„¤ê³„ ê·¼ê±°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤

- ì¹´ë””ë„ë¦¬í‹° ê³ ë ¤: ì¼ë°˜ì ìœ¼ë¡œ ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©ì ìˆ˜(user_id)ëŠ” ì¿ í° ì›ì¥ ìˆ˜(coupon_id)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤. ë†’ì€ ì¹´ë””ë„ë¦¬í‹°ë¥¼ ê°€ì§„ ì»¬ëŸ¼ì„ ì¸ë±ìŠ¤ ì•ë¶€ë¶„ì— ë°°ì¹˜í•˜ëŠ” ê²ƒì´ íš¨ìœ¨ì ì…ë‹ˆë‹¤. ë˜í•œ ë‘
  ì¡°ê±´ì€ ëª¨ë‘ ë™ì¹˜ ì¡°ê±´ì´ë¯€ë¡œ ì¹´ë”” ë„ë¦¬í‹°ê°€ ë†’ì€ ê²ƒë¶€í„° ë†“ëŠ” ê²ƒì´ íš¨ìœ¨ì ì…ë‹ˆë‹¤.

- ì¿ í° ë°œê¸‰ ì •ì±… ë°˜ì˜: ì‹œìŠ¤í…œì—ì„œëŠ” ì‚¬ìš©ìë‹¹ ë™ì¼ ì¿ í°ì€ ìµœëŒ€ 1ê°œë§Œ ë°œí–‰ë˜ë¯€ë¡œ, (user_id, coupon_id) ìŒì€ ìœ ì¼ì„±ì„ ê°€ì§‘ë‹ˆë‹¤.

- ì¿¼ë¦¬ íŒ¨í„´ ìµœì í™”: WHERE ì ˆì˜ ì¡°ê±´ ìˆœì„œ(user_id, coupon_id)ì™€ ì¸ë±ìŠ¤ ì»¬ëŸ¼ ìˆœì„œë¥¼ ì¼ì¹˜ì‹œì¼œ ì¸ë±ìŠ¤ íš¨ìœ¨ì„±ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.

### 4. ì„±ëŠ¥ ê°œì„  ê²°ê³¼

```sql
-> Limit: 1 row(s)  (cost=1.1 rows=1) (actual time=0.0124..0.0124 rows=0 loops=1)
    -> Covering index lookup on published_coupon using idx_user_coupon (user_id=8478465, coupon_id=1)  (cost=1.1 rows=1) (actual time=0.0114..0.0114 rows=0 loops=1)
```

ì¸ë±ìŠ¤ ì ìš© í›„ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ì´ 1.882ì´ˆì—ì„œ 0.0124msë¡œ ë‹¨ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤.(ì•½ 151,774ë°° ì„±ëŠ¥ í–¥ìƒ)  
ì»¤ë²„ë§ ì¸ë±ìŠ¤(Covering Index)ê°€ ì ìš©ë˜ì–´ í…Œì´ë¸” ì ‘ê·¼ ì—†ì´ ì¸ë±ìŠ¤ë§Œìœ¼ë¡œ ì¿¼ë¦¬ê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.  
ì‚¬ìš©ì ì¿ í° ì •ë³´ ì¡°íšŒ ì¿¼ë¦¬ë„ ìœ ì‚¬í•œ ì„±ëŠ¥ ê°œì„ ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.

```sql
##
ì‚¬ìš©ì ì¿ í° ì¡°íšŒ ê²°ê³¼ X
explain analyze
SELECT id,
       user_id,
       coupon_id,
       discount_type,
       discount_value,
       valid_from,
       valid_to,
       is_used,
       issued_at,
       ordered_at,
       updated_at
FROM published_coupon
WHERE coupon_id = 1
  AND user_id = 8478465;

-> Index lookup on published_coupon using idx_user_coupon (user_id=8478465, coupon_id=1)  (cost=1.09 rows=1) (actual time=0.0993..0.0993 rows=0 loops=1)
```

ì´ëŸ¬í•œ ì„±ëŠ¥ ê°œì„ ì€ ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ APIì™€ ì£¼ë¬¸ ì‹œ ì¿ í° ì ìš© ë¡œì§ì—ì„œ ì‚¬ìš©ì ê²½í—˜ì„ í¬ê²Œ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## âœ… Orders í…Œì´ë¸”ì—ì„œ ì‹œê°„ ë²”ìœ„ì— ë”°ë¥¸ ì£¼ë¬¸ ì¡°íšŒ ì„±ëŠ¥ ë¶„ì„

### 1. ì‹œë‚˜ë¦¬ì˜¤ ë° ë¬¸ì œ ì •ì˜

í•­í•´ í”ŒëŸ¬ìŠ¤ ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì—ì„œëŠ” ì¸ê¸° ìƒí’ˆ ë¶„ì„ì„ ìœ„í•´ ë§¤ ì •ê°ë§ˆë‹¤ ê²°ì œ ì™„ë£Œ ìƒíƒœì´ë©´ì„œ ìµœê·¼ 1ì‹œê°„ ì´ë‚´ì— ìƒì„±ëœ ì£¼ë¬¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

```sql
SELECT id,
       user_id,
       product_id,
       order_status,
       payment_method,
       total_price,
       discount_price,
       ordered_at,
       updated_at
FROM orders
WHERE order_status = 'PAID'
  AND ordered_at >= '2025-04-17 11:00:00'
  AND ordered_at < '2025-04-17 12:00:00';
```

### 2. ì‹¤í–‰ ê³„íš ë¶„ì„

í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- MySQL 8.0.32
- 2025ë…„ 01ì›” 01ì¼ë¶€í„° 04ì›” 17ì¼ê¹Œì§€ì˜ ë°ì´í„° ì¡´ì¬
- ì´ ì•½ 1,000ë§Œ ê±´ì˜ ì£¼ë¬¸ ë°ì´í„°

```sql
-> Filter: ((orders.order_status = 'PAID') and (orders.ordered_at >= TIMESTAMP'2025-04-17 11:00:00') and (orders.ordered_at < TIMESTAMP'2025-04-17 12:00:00'))  (cost=1.01e+6 rows=107700) (actual time=2356..2610 rows=24858 loops=1)
    -> Table scan on orders  (cost=1.01e+6 rows=9.69e+6) (actual time=0.373..2100 rows=10e+6 loops=1)
```

ë¶„ì„

- ì¸ë±ìŠ¤ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ í…Œì´ë¸” í’€ ìŠ¤ìº”ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.
- ì‹¤í–‰ ì‹œê°„: ì•½ 2.61ì´ˆ

ì¸ë±ìŠ¤ê°€ ì—†ëŠ” ìƒí™©ì—ì„œ ì „ì²´ í…Œì´ë¸”ì„ ìŠ¤ìº”í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ì´ëŸ¬í•œ ì„±ëŠ¥ì€ ë°ì´í„°ê°€ ì¦ê°€í• ìˆ˜ë¡ ë”ìš± ì•…í™”ë˜ë©°, ì •ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ë°°ì¹˜ ì‘ì—…ì—ì„œ ì‹œìŠ¤í…œ ì „ì²´ ì„±ëŠ¥ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3. ì„±ëŠ¥ ê°œì„  ì „ëµ: ì¸ë±ìŠ¤ ë¹„êµ ë¶„ì„

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€í•  ê²ƒì…ë‹ˆë‹¤.

```sql
CREATE INDEX idx_created_status ON orders (ordered_at, order_status);

CREATE INDEX idx_order_status_ordered_at ON orders (order_status, ordered_at);
```

ë‘ ì¸ë±ìŠ¤ ëª¨ë‘ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³¸ ê²°ê³¼, ë‘ ì¸ë±ìŠ¤ë¥¼ ê°ê° ì ìš©í•´ì„œ ì–»ì€ ì‹¤í–‰ ê³„íš ë¶„ì„ ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

**CASE 1 : idx_created_status**

```sql
-> Index range scan on orders using idx_created_status over ('2025-04-17 11:00:00' <= ordered_at <= '2025-04-17 12:00:00' AND 'PAID' <= order_status),
with index condition: ((orders.order_status = 'PAID') and (orders.ordered_at >= TIMESTAMP'2025-04-17 11:00:00') and (orders.ordered_at < TIMESTAMP'2025-04-17 12:00:00'))  
(cost=87554 rows=82162) (actual time=10.3..54 rows=24858 loops=1)
```

**CASE 2 : idx_status_created**

```sql
-> Index range scan on orders using idx_status_created over (order_status = 'PAID' AND '2025-04-17 11:00:00' <= ordered_at < '2025-04-17 12:00:00'), 
with index condition: ((orders.order_status = 'PAID') and (orders.ordered_at >= TIMESTAMP'2025-04-17 11:00:00') and (orders.ordered_at < TIMESTAMP'2025-04-17 12:00:00')) 
(cost=51614 rows=48230) (actual time=8.88..49.6 rows=24858 loops=1)
```

ìœ„ì˜ ì‹¤í–‰ ê³„íšì„ ë¶„ì„í•´ë³´ë©´ í˜„ì¬ ë°ì´í„°ì…‹ ê¸°ì¤€ ì‹¤í–‰ ì†ë„ì˜ ì°¨ì´ëŠ” í¬ì§€ ì•Šì§€ë§Œ, idx_created_status ì¸ë±ìŠ¤ëŠ” ë†’ì€ ì¹´ë””ë„ë¦¬í‹°ì—ì„œ  
ë‚®ì€ ì¹´ë””ë„ë¦¬í‹° ìˆœì„œë¡œ ì¸í•´ í•„í„°ë§ íš¨ìœ¨ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì£¼ë¬¸ í…Œì´ë¸”ì˜ order_status ì»¬ëŸ¼ì€ ìš°ë¦¬ì˜ ì‹œìŠ¤í…œì—ì„œ  
ëŒ€ë¶€ë¶„ì˜ ê°’ì´ PAIDì¼ ê²ƒì´ê¸° ë•Œë¬¸ì— (5ë¶„ì´ ì§€ë‚˜ë„ ê²°ì œë˜ì§€ ì•Šì€ ì£¼ë¬¸ ê±´ì€ EXPIREDë¡œ ë³€ê²½í•˜ë¯€ë¡œ) í•„í„°ë§ì—ì„œ ëŒ€ë¶€ë¶„ì˜ rowê°€ ë‚¨ìŠµë‹ˆë‹¤.

### 4. ê²°ë¡ 

ê²°ê³¼ì ìœ¼ë¡œ idx_order_status_ordered_at ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì¼ ê²ƒì…ë‹ˆë‹¤. ë¿ë§Œ ì•„ë‹ˆë¼ ì£¼ë¬¸ì˜ id ìì²´ë§Œ í•„ìš”í•œ ê²½ìš°ì—ëŠ”  
ìŠ¤í”„ë§ë¶€íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ DTO(id, order_status, orderedAt)ë¡œ ë³€í™˜í•˜ì—¬ ì¡°íšŒí•œë‹¤ë©´ ì»¤ë²„ë§ ì¸ë±ìŠ¤ê°€ ì ìš©ë˜ì–´ ë”ìš± ë¹ ë¥´ê²Œ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
SELECT id, order_status, ordered_at
FROM orders
WHERE order_status = 'PAID'
  AND ordered_at >= '2025-04-17 11:00:00'
  AND ordered_at < '2025-04-17 12:00:00';

-> Filter: ((orders.order_status = 'PAID') and (orders.ordered_at >= TIMESTAMP'2025-04-17 11:00:00') and (orders.ordered_at < TIMESTAMP'2025-04-17 12:00:00'))  (cost=10201 rows=48230) (actual time=0.204..8.81 rows=24858 loops=1)
    -> Covering index range scan on orders using idx_status_created over (order_status = 'PAID' AND '2025-04-17 11:00:00' <= ordered_at < '2025-04-17 12:00:00')  (cost=10201 rows=48230) (actual time=0.194..5.61 rows=24858 loops=1)
```

í•˜ì§€ë§Œ ìš°ë¦¬ì˜ ì‹œìŠ¤í…œì—ì„œ order_statusëŠ” ë¯¸ê²°ì œ(PENDING)ì—ì„œ ê²°ì œ ì™„ë£Œ(PAID)ë¡œ, í˜¹ì€ ë¯¸ê²°ì œ(PENDING)ì´ 5ë¶„ì´ ë„˜ìœ¼ë©´  
ì£¼ë¬¸ ë§Œë£Œ(EXPIRED)ë¡œ ë³€ê²½ ë˜ëŠ” ì¼ì´ ë¹ˆë²ˆí•˜ê¸° ë•Œë¬¸ì— ì¸ë±ìŠ¤ ì¬ì •ë ¬/ì¬ë°°ì¹˜ ì‘ì—… ì—­ì‹œ ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚˜ ì¸ë±ìŠ¤ë¥¼ ì†ìƒì‹œí‚µë‹ˆë‹¤.  
1000ë§Œ ê±´ì˜ ìˆ˜ì¤€ì—ì„œëŠ” í¬ê²Œ ëŠë¦° í¸ì´ ì•„ë‹ˆì§€ë§Œ ì¸ë±ìŠ¤ ì†ìƒìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•  ê²½ìš° ordered_at ì»¬ëŸ¼ì„ ë‹¨ë… ì¸ë±ìŠ¤ë¡œ ì§€ì •í•˜ê±°ë‚˜  
ì£¼ë¬¸ ìƒíƒœì— ë”°ë¥¸ í…Œì´ë¸” ë¶„ë¦¬ë¥¼ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## âœ… ì¸ê¸°ìƒí’ˆ ì¡°íšŒ ì„±ëŠ¥ ë¶„ì„

### 1. ì‹œë‚˜ë¦¬ì˜¤ ë° ë¬¸ì œ ì •ì˜

í•­í•´ í”ŒëŸ¬ìŠ¤ ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì—ì„œëŠ” ì¸ê¸° ìƒí’ˆì„ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ë©° ì´ë¥¼ í†µí•´ ì¼ê°„, ì£¼ê°„, ì›”ê°„ ì¸ê¸° ìƒí’ˆì„ ì¡°íšŒí•  ìˆ˜ ìˆê³  ìƒí’ˆì€ íŒë§¤ëŸ‰ ìˆœìœ¼ë¡œ ë³´ì—¬ì§‘ë‹ˆë‹¤.
ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ì¿¼ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```sql
SELECT *
FROM bestseller
WHERE created_at >= NOW() - INTERVAL 1 DAY -- ì¼ê°„
ORDER BY sales_count DESC
    LIMIT 100;

SELECT *
FROM bestseller
WHERE created_at >= NOW() - INTERVAL 7 DAY
ORDER BY sales_count DESC
    LIMIT 100;

SELECT *
FROM bestseller
WHERE created_at >= NOW() - INTERVAL 1 MONTH
ORDER BY sales_count DESC
    LIMIT 100;
```

### 2. ì‹¤í–‰ ê³„íš ë¶„ì„

í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- MySQL 8.0.32
- 2025ë…„ 01ì›” 18ì¼ë¶€í„° 04ì›” 17ì¼ê¹Œì§€ì˜ ë°ì´í„° ì¡´ì¬
- ì´ 100ë§Œ ê±´ì˜ ì£¼ë¬¸ ë°ì´í„°

```sql
-> Limit: 100 row(s)  (cost=36578 rows=100) (actual time=354..354 rows=100 loops=1)
    -> Sort: bestseller.sales_count DESC, limit input to 100 row(s) per chunk  (cost=36578 rows=992118) (actual time=354..354 rows=100 loops=1)
        -> Filter: (bestseller.created_at >= <cache>((now() - interval 1 day)))  (cost=36578 rows=992118) (actual time=0.0868..352 rows=11228 loops=1)
            -> Table scan on bestseller  (cost=36578 rows=992118) (actual time=0.0643..317 rows=1e+6 loops=1)

```

ë¶„ì„

- ì¸ë±ìŠ¤ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ í…Œì´ë¸” í’€ ìŠ¤ìº”ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.
- ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” â†’ í•„í„°ë§(1ì¼ì¹˜) â†’ ì •ë ¬(ë§¤ì¶œìˆœ) â†’ ì œí•œ(100ê±´) ìˆœìœ¼ë¡œ ì²˜ë¦¬
- ë³‘ëª©ì€ **ì •ë ¬ ë‹¨ê³„(354ms)**ë¡œ, 11,228í–‰ì„ ë©”ëª¨ë¦¬ ì •ë ¬í•˜ëŠ” ë° ëŒ€ë¶€ë¶„ ì‹œê°„ì´ ì†Œìš”ë˜ê³  ìˆìŠµë‹ˆë‹¤.

### 3. ì„±ëŠ¥ ê°œì„  ì „ëµ: ì¸ë±ìŠ¤ ë¹„êµ ë¶„ì„

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€í•  ê²ƒì…ë‹ˆë‹¤.

```sql
CREATE INDEX idx_created_at_sales_count ON bestseller (created_at, sales_count);

CREATE INDEX idx_sales_count_created_at ON bestseller (sales_count, created_at);
```

ë‘ ì¸ë±ìŠ¤ ëª¨ë‘ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³¸ ê²°ê³¼, ë‘ ì¸ë±ìŠ¤ë¥¼ ê°ê° ì ìš©í•´ì„œ ì–»ì€ ì‹¤í–‰ ê³„íš ë¶„ì„ ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

**CASE 1 : idx_created_at_sales_count**

```sql
-- ì¼ê°„ ì¡°íšŒ
-> Limit: 100 row(s)  (cost=12407 rows=100) (actual time=92..92 rows=100 loops=1)
    -> Sort: bestseller.sales_count DESC, limit input to 100 row(s) per chunk  (cost=12407 rows=21498) (actual time=92..92 rows=100 loops=1)
        -> Index range scan on bestseller using idx_created_at_sales_count over ('2025-04-16 16:44:08' <= created_at), with index condition: (bestseller.created_at >= <cache>((now() - interval 1 day)))  (cost=12407 rows=21498) (actual time=0.0384..90.1 rows=11228 loops=1)

-- ì›”ê°„ ì¡°íšŒ
-> Limit: 100 row(s)  (cost=103520 rows=100) (actual time=463..463 rows=100 loops=1)
    -> Sort: bestseller.sales_count DESC, limit input to 100 row(s) per chunk  (cost=103520 rows=992118) (actual time=463..463 rows=100 loops=1)
        -> Filter: (bestseller.created_at >= <cache>((now() - interval 1 month)))  (cost=103520 rows=992118) (actual time=0.141..423 rows=345396 loops=1)
            -> Table scan on bestseller  (cost=103520 rows=992118) (actual time=0.134..384 rows=1e+6 loops=1)
```

- ì¼ê°„ ì¡°íšŒì—ì„œëŠ” ì¤€ìˆ˜í•œ ì„±ëŠ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
- í•˜ì§€ë§Œ ì›”ê°„ ì¡°íšŒë¥¼ ë„˜ì–´ê°€ëŠ” ê²½ìš° í’€ ìŠ¤ìº”ì„ í•˜ë©´ì„œ ë¹„íš¨ìœ¨ì´ ë°œìƒí•©ë‹ˆë‹¤.
- ì¦‰ ì›”ê°„ì„ ë„ˆë¨¸ ë¶„ê¸°, ë°˜ê¸°, ì—°ê°„ ë‹¨ìœ„ë¡œ ì¡°íšŒí•  ê²½ìš° ì¸ë±ìŠ¤ íš¨ìœ¨ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤.

**CASE 2 : idx_sales_count_created_at**

```sql
-- ì¼ê°„
-> Limit: 100 row(s)  (cost=0.343 rows=33.3) (actual time=0.179..39 rows=100 loops=1)
    -> Filter: (bestseller.created_at >= <cache>((now() - interval 1 day)))  (cost=0.343 rows=33.3) (actual time=0.178..39 rows=100 loops=1)
        -> Index scan on bestseller using idx_sales_count_created_at (reverse)  (cost=0.343 rows=100) (actual time=0.175..38.7 rows=7985 loops=1)

-- ì›”ê°„
-> Limit: 100 row(s)  (cost=0.343 rows=33.3) (actual time=0.0483..2.5 rows=100 loops=1)
    -> Filter: (bestseller.created_at >= <cache>((now() - interval 1 month)))  (cost=0.343 rows=33.3) (actual time=0.0473..2.49 rows=100 loops=1)
        -> Index scan on bestseller using idx_sales_count_created_at (reverse)  (cost=0.343 rows=100) (actual time=0.0439..2.48 rows=100 loops=1)
```

- ë°˜ë©´ ì •ë ¬ ì¡°ê±´ì¸ íŒë§¤ëŸ‰ì„ ì•ì— ë‘ë©´ ì—­ì¸ë±ìŠ¤ ìŠ¤ìº”ìœ¼ë¡œ ì •ë ¬ê³¼ í•„í„°ë§ì„ ì¸ë±ìŠ¤ ë‹¨ê³„ì—ì„œ ë™ì‹œì— í•´ê²°í•©ë‹ˆë‹¤.
- ë”°ë¼ì„œ íŒŒì¼ ì†ŒíŠ¸ì™€ í’€ìŠ¤ìº”ì´ ì „í˜€ ì—†ì–´ ì‹¤í–‰ ì‹œê°„ì´ ê·¹ì ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.

### 4. ê²°ë¡ 

ê²°ê³¼ì ìœ¼ë¡œ idx_sales_count_created_at ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì…ë‹ˆë‹¤. ì´í›„ ë” ë§ì€ ë°ì´í„° ì‚½ì…ì´ ë°œìƒí•œë‹¤ë©´  
ìºì‹œë¥¼ í™œìš©í•˜ê±°ë‚˜ ê¸°ê°„ ë³„ íŒŒí‹°ì…˜ì„ ë‚˜ëˆ„ëŠ” ë°©ë²•ì„ êµ¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì¶”ê°€ ê³ ë ¤ ì‚¬í•­

ì´ì™¸ì—ë„ ë‹¤ìŒê³¼ ê°™ì€ ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. ì£¼ë¬¸ì— ì†í•˜ëŠ” ì£¼ë¬¸ ìƒí’ˆ(OrderProdudct) í…Œì´ë¸”ì˜ order_id ì»¬ëŸ¼ ë‹¨ë… ì¸ë±ìŠ¤
    - ê·¼ê±°: ì£¼ë¬¸ ìƒì„¸ ì¡°íšŒ ì‹œ íŠ¹ì • ì£¼ë¬¸(order_id)ì— ì†í•œ ëª¨ë“  ìƒí’ˆì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•©ë‹ˆë‹¤.
    - íš¨ê³¼: ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ ë¡œë”© ì‹œê°„ì´ í¬ê²Œ ë‹¨ì¶•ë˜ë©°, íŠ¹íˆ ëŒ€ëŸ‰ ì£¼ë¬¸(ë§ì€ ìƒí’ˆì„ í¬í•¨í•œ ì£¼ë¬¸)ì—ì„œ íš¨ê³¼ì ì…ë‹ˆë‹¤.

2. ìƒí’ˆë³„ íŒë§¤ëŸ‰ ë¶„ì„ ë“±ì„ ìœ„í•´ ì£¼ë¬¸ ìƒí’ˆ í…Œì´ë¸”ì˜ product_id ì»¬ëŸ¼ ë‹¨ë… ì¸ë±ìŠ¤
    - ê·¼ê±°: ìƒí’ˆë³„ íŒë§¤ëŸ‰ ë¶„ì„, ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ë“±ì—ì„œ íŠ¹ì • ìƒí’ˆì˜ ì£¼ë¬¸ ì´ë ¥ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
    - íš¨ê³¼: ìƒí’ˆ ë¶„ì„ ëŒ€ì‹œë³´ë“œ ë° ë¦¬í¬íŠ¸ ìƒì„± ì†ë„ê°€ ê°œì„ ë©ë‹ˆë‹¤.
    - í™œìš© ì‚¬ë¡€: "ì´ ìƒí’ˆì„ êµ¬ë§¤í•œ ì‚¬ëŒë“¤ì´ í•¨ê»˜ êµ¬ë§¤í•œ ìƒí’ˆ" ì¶”ì²œ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ í•µì‹¬ ì¸ë±ìŠ¤ë¡œ í™œìš©ë©ë‹ˆë‹¤.

## ğŸ“Œ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„±ëŠ¥ ìµœì í™” ì „ëµ ìš”ì•½

| ì‹œë‚˜ë¦¬ì˜¤ | ëª©ì /ê¸°ëŠ¥ ì„¤ëª…                     | ëŒ€ìƒ í…Œì´ë¸”             | ë¬¸ì œì  ìš”ì•½                                           | ì¸ë±ìŠ¤ ì „ëµ                                                      | ì„±ëŠ¥ ê°œì„  íš¨ê³¼ ìš”ì•½                                |
|------|------------------------------|--------------------|--------------------------------------------------|-------------------------------------------------------------|--------------------------------------------|
| â‘     | ì‚¬ìš©ì ì¿ í° ë°œê¸‰ ì—¬ë¶€ í™•ì¸ (ì„ ì°©ìˆœ ì¿ í° API) | `published_coupon` | 1000ë§Œ ê±´ í’€ìŠ¤ìº” + `LIMIT 1`ì´ ë¬´ì˜ë¯¸ (ì¡°ê±´ ë§Œì¡± ëª»í•˜ë©´ ì „ê±´ íƒìƒ‰ë¨)  | `idx_user_coupon (user_id, coupon_id)`                      | 1.8ì´ˆ â†’ 0.012ms (ì•½ 150,000ë°° ê°œì„ ), ì»¤ë²„ë§ ì¸ë±ìŠ¤ ê°€ëŠ¥ |
| â‘¡    | ì‚¬ìš©ì ì¿ í° ìƒì„¸ ì¡°íšŒ                 | `published_coupon` | user_idë§Œ ì¡°ê±´ì´ë©´ ì¸ë±ìŠ¤ ì¼ë¶€ë§Œ ì‚¬ìš© â†’ ì„±ëŠ¥ ì €í•˜ ìœ„í—˜              | ë™ì¼í•˜ê²Œ `idx_user_coupon`                                      | ì „ì²´ ì •ë³´ ì¡°íšŒ ì‹œì—ë„ ë¹ ë¥¸ ì¸ë±ìŠ¤ íƒìƒ‰ ë° ì»¤ë²„ë§ ê°€ëŠ¥            |
| â‘¢    | ìµœê·¼ 1ì‹œê°„ ê²°ì œ ì™„ë£Œ ì£¼ë¬¸ ì¡°íšŒ (ì •ê° ë°°ì¹˜ìš©)  | `orders`           | 1000ë§Œ ê±´ í…Œì´ë¸”ì—ì„œ `PAID` + `ordered_at` í•„í„°ë§ ì‹œ í’€ìŠ¤ìº” ë°œìƒ | `idx_status_created (order_status, ordered_at)`             | Index Range Scan + ì •ë ¬ ì œê±° â†’ 2.6ì´ˆ â†’ 49ms ìˆ˜ì¤€  |
| â‘£    | ì¸ê¸° ìƒí’ˆ ì¡°íšŒ (ì¼ê°„/ì£¼ê°„/ì›”ê°„)          | `bestseller`       | created_atë§Œ ì¡°ê±´ì´ë©´ ì •ë ¬ ìœ„í•´ íŒŒì¼ ì†ŒíŠ¸ ë°œìƒ, ì›”ê°„ ì´ìƒì—ì„œ í’€ìŠ¤ìº” ë°œìƒ  | `idx_sales_count_created_at (sales_count DESC, created_at)` | ì •ë ¬+í•„í„°ë§ ëª¨ë‘ ì¸ë±ìŠ¤ë¡œ í•´ê²°, ì›”ê°„ ì¡°íšŒë„ ìˆ˜ msë¡œ ê°€ëŠ¥         |
| â‘¤    | ì£¼ë¬¸ ìƒì„¸ ìƒí’ˆ ì¡°íšŒ (1:N ê´€ê³„)         | `order_product`    | íŠ¹ì • ì£¼ë¬¸(order_id) í•˜ìœ„ ìƒí’ˆ ì „ì²´ ì¡°íšŒ ì‹œ í…Œì´ë¸” ì „ê±´ ì¡°íšŒë  ìœ„í—˜      | `idx_order_id`                                              | ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ ë¡œë”© ì†ë„ í–¥ìƒ                         |
| â‘¥    | ìƒí’ˆë³„ ì£¼ë¬¸/íŒë§¤ëŸ‰ ì¡°íšŒ                | `order_product`    | product_idë¡œ í•„í„°ë§ ì‹œ ì„ í˜• íƒìƒ‰ ë°œìƒ ê°€ëŠ¥                    | `idx_product_id`                                            | ìƒí’ˆë³„ í†µê³„ ë¶„ì„ ì†ë„ ê°œì„ , ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ ë“±ì— ìœ ìš©             |

---

## âœ… í•µì‹¬ ì •ë¦¬ ë° ì„¤ê³„ ì›ì¹™

- **ì¹´ë””ë„ë¦¬í‹° ë†’ì€ ì»¬ëŸ¼ì„ ë³µí•© ì¸ë±ìŠ¤ ì•ì— ë°°ì¹˜í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤.**
    - ë‹¨, ì¡°ê±´ì´ ë™ì¹˜(=) vs ë²”ìœ„(BETWEEN, >=) ì¡°í•©ì¼ ê²½ìš°: ë™ì¹˜ ì¡°ê±´ ìš°ì„  ë°°ì¹˜
- **Covering Indexë¥¼ í™œìš©í•˜ë¼.**
    - ì¿¼ë¦¬ì— ì‚¬ìš©ë˜ëŠ” ëª¨ë“  ì»¬ëŸ¼ì„ ì¸ë±ìŠ¤ì— í¬í•¨ì‹œí‚¤ë©´ ì„±ëŠ¥ ê¸‰ìƒìŠ¹
- **ì •ë ¬ì´ í•„ìš”í•œ ì¿¼ë¦¬ëŠ” ì •ë ¬ ëŒ€ìƒ ì»¬ëŸ¼ì´ ì¸ë±ìŠ¤ì— í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.**
    - `ORDER BY sales_count DESC` + `created_at >= ?` â†’ `idx_sales_count_created_at`
- **ë¹ˆë²ˆí•œ UPDATEê°€ ë°œìƒí•˜ëŠ” ì»¬ëŸ¼ì€ ì¸ë±ìŠ¤ ì„¤ê³„ ì‹œ ì‹ ì¤‘í•´ì•¼ í•œë‹¤.**
    - ì˜ˆ: ì£¼ë¬¸ ìƒíƒœ(order_status)ëŠ” ìì£¼ ë°”ë€Œë¯€ë¡œ ì¸ë±ìŠ¤ ì†ìƒ ê°€ëŠ¥ì„± ìˆìŒ


